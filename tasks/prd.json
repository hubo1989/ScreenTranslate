{
  "name": "Window Detection Auto-Select",
  "description": "在区域选择模式中增加窗口自动识别能力，支持悬停高亮窗口并单击选取，同时保留拖拽自定义选区功能",
  "branchName": "ralph/window-detection-auto-select",
  "userStories": [
    {
      "id": "US-001",
      "title": "创建 WindowDetector 窗口检测服务",
      "description": "作为开发者，我需要封装 CGWindowListCopyWindowInfo API 来检测鼠标光标下方的窗口",
      "acceptanceCriteria": [
        "创建 WindowDetector.swift 文件在 ScreenTranslate/Services/ 目录",
        "实现 WindowInfo 结构体包含 windowID、frame、ownerName、windowName、windowLayer",
        "实现 windowUnderPoint(_:) 方法返回光标下方最顶层可见窗口",
        "实现 visibleWindows() 方法返回所有可见窗口列表",
        "过滤掉 kCGWindowLayer != 0 的系统级窗口（Dock、Menu Bar）",
        "过滤掉自身应用的覆盖层窗口",
        "窗口列表按 Z-order 排序",
        "代码通过 Swift 编译，无警告"
      ],
      "priority": 1,
      "passes": true,
      "notes": "",
      "dependsOn": [],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-002",
      "title": "SelectionOverlayView 窗口高亮绘制",
      "description": "作为用户，我悬停在窗口上时能看到高亮框标识出窗口边界",
      "acceptanceCriteria": [
        "在 SelectionOverlayView 中新增 highlightedWindowRect 属性存储当前高亮窗口 frame",
        "新增 windowDetector 实例用于窗口检测",
        "在 mouseMoved 中调用 windowDetector.windowUnderPoint 检测光标下方窗口",
        "将窗口 frame 从 Quartz 坐标系转换为 view 坐标系",
        "在 draw(_:) 中绘制窗口高亮框：蓝色填充 (alpha 0.08) + 蓝色边框 (alpha 0.5, 2pt)",
        "暗色覆盖层在窗口区域挖洞（使用 even-odd fill rule）",
        "窗口高亮时显示尺寸标签（复用 drawDimensionsLabel）",
        "光标移到无窗口区域时高亮框消失"
      ],
      "priority": 2,
      "passes": true,
      "notes": "",
      "dependsOn": [
        "US-001"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-003",
      "title": "点击与拖拽区分逻辑",
      "description": "作为用户，我可以单击选取高亮窗口，也可以拖拽进行自定义区域选择",
      "acceptanceCriteria": [
        "新增 dragThreshold 常量（4px）用于区分点击和拖拽",
        "新增 mouseDownPoint 属性记录鼠标按下位置",
        "改造 mouseDown：记录起始点，刷新窗口缓存，不立即开始选区",
        "改造 mouseDragged：计算移动距离，超过阈值后进入拖拽模式",
        "拖拽模式启动时清除 highlightedWindowRect，设置 selectionStart/selectionCurrent",
        "改造 mouseUp：判断 isDragging 状态，区分点击和拖拽",
        "点击模式：若 highlightedWindowRect 存在，将其转换为 display-relative 坐标并调用 delegate",
        "点击模式：若 highlightedWindowRect 不存在，调用 selectionOverlayDidCancel",
        "拖拽模式：执行现有的选区完成逻辑",
        "重置所有状态变量"
      ],
      "priority": 3,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-002"
      ]
    },
    {
      "id": "US-004",
      "title": "性能优化与边界情况处理",
      "description": "作为开发者，我需要确保窗口检测流畅且能正确处理各种边界情况",
      "acceptanceCriteria": [
        "实现窗口列表缓存机制：mouseDown 时刷新，mouseMoved 使用缓存",
        "实现节流机制：mouseMoved 窗口检测 16ms 节流",
        "实现增量更新：highlightedWindowRect 变化时才触发 needsDisplay",
        "处理多显示器场景：每个显示器独立检测，使用全局屏幕坐标",
        "处理窗口部分在屏幕外：高亮框裁剪到屏幕可见范围",
        "处理极小窗口：小于 10x10 像素的窗口跳过不高亮",
        "处理全屏应用窗口：正常检测和高亮",
        "ESC 键在窗口高亮状态下正确取消并关闭覆盖层"
      ],
      "priority": 4,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-003"
      ]
    },
    {
      "id": "US-005",
      "title": "集成测试与验证",
      "description": "作为开发者，我需要验证整个功能在截图和翻译模式下都能正常工作",
      "acceptanceCriteria": [
        "区域截图模式：窗口高亮、单击选取、拖拽圈选功能正常",
        "翻译模式：窗口高亮、单击选取、拖拽圈选功能正常",
        "单击选取窗口后截取的图像范围精确匹配窗口 frame",
        "多显示器环境下窗口检测在所有显示器上正常工作",
        "快速移动鼠标时无明显卡顿（视觉流畅）",
        "覆盖层关闭后内存正确释放，无泄漏"
      ],
      "priority": 5,
      "passes": false,
      "notes": "",
      "dependsOn": [
        "US-004"
      ]
    }
  ],
  "metadata": {
    "updatedAt": "2026-02-09T07:04:46.753Z"
  }
}