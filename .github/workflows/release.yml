name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

env:
  PROJECT_NAME: ScreenTranslate

jobs:
  build:
    runs-on: macos-15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.2'

      - name: Build Release
        run: |
          xcodebuild -project ${{ env.PROJECT_NAME }}.xcodeproj \
            -scheme ${{ env.PROJECT_NAME }} \
            -configuration Release \
            -derivedDataPath build \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            MACOSX_DEPLOYMENT_TARGET=15.0 \
            ONLY_ACTIVE_ARCH=NO \
            clean build

      - name: Create DMG
        id: create_dmg
        run: |
          mkdir -p dmg_temp
          cp -R build/Build/Products/Release/${{ env.PROJECT_NAME }}.app dmg_temp/
          ln -sf /Applications dmg_temp/Applications

          VERSION=${GITHUB_REF#refs/tags/v}
          DMG_FILE="${{ env.PROJECT_NAME }}-${VERSION}.dmg"

          hdiutil create -volname "${{ env.PROJECT_NAME }}" \
            -srcfolder dmg_temp \
            -ov -format UDZO \
            "$DMG_FILE"

          # Get file size
          DMG_SIZE=$(stat -f%z "$DMG_FILE")
          echo "dmg_size=$DMG_SIZE" >> $GITHUB_OUTPUT

          rm -rf dmg_temp

      - name: Generate pubDate
        id: pubdate
        run: echo "date=$(date -Ru)" >> $GITHUB_OUTPUT

      - name: Generate Sparkle Appcast
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          DMG_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${{ env.PROJECT_NAME }}-${VERSION}.dmg"
          PUBDATE="${{ steps.pubdate.outputs.date }}"
          DMG_SIZE="${{ steps.create_dmg.outputs.dmg_size }}"

          cat > appcast.xml << EOF
          <?xml version="1.0" encoding="utf-8"?>
          <rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">
            <channel>
              <title>${{ env.PROJECT_NAME }} Updates</title>
              <link>https://github.com/${{ github.repository }}/releases</link>
              <description>Most recent changes with links to updates.</description>
              <language>en</language>
              <item>
                <title>Version ${VERSION}</title>
                <pubDate>${PUBDATE}</pubDate>
                <sparkle:version>${VERSION}</sparkle:version>
                <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>
                <sparkle:minimumSystemVersion>15.0</sparkle:minimumSystemVersion>
                <enclosure url="${DMG_URL}" length="${DMG_SIZE}" type="application/octet-stream" />
              </item>
            </channel>
          </rss>
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.PROJECT_NAME }}-*.dmg
            appcast.xml
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        run: rm -rf build
